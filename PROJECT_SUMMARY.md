# Анализ файлов проекта TGFlow

Этот документ содержит описание структуры проекта, назначения каждого файла и принципов его работы.

---

### 1. Ядро и Интерфейс

#### `main.py`
*   **Зачем:** Основная точка входа и управляющий центр приложения.
*   **Что делает:** Содержит код главного окна (`TelegramApp`) и логику многопоточной рассылки.
*   **Как работает:**
    *   Использует **PyQt6** для отрисовки интерфейса (вкладки: Рассылка, Аккаунты, Скрипты, История, О программе).
    *   **Интеграция Mini App:** Включает в себя функционал `MiniBroadcastApp` (доступен через кнопку "✉️ Открыть окно рассылки по чатам" на вкладке "Рассылка"). Это позволяет использовать упрощенный интерфейс рассылки параллельно с основным.
    *   Включает класс `OptimizedBroadcastWorker` (наследник `QThread`), который управляет отправкой. Реализует "волновую" стратегию: по одному сообщению с каждого аккаунта по очереди для обхода ограничений.
    *   Обеспечивает процесс авторизации Telegram (коды подтверждения, 2FA пароли).

#### `app_paths.py`
*   **Зачем:** Управление путями к данным.
*   **Что делает:** Гарантирует, что сессии, логи и настройки хранятся в стандартных системных директориях пользователя.
*   **Как работает:** Определяет переменную `USER_DATA_DIR` (например, `~/Library/Application Support/TGFlow` на macOS). Это критично для корректной работы приложения при запуске из защищенных образов (DMG) или инсталляторов.

---

### 2. Логика рассылки и Данные

#### `broadcast_state.py`
*   **Зачем:** Функция "Возобновления" (Resume) рассылки.
*   **Что делает:** Сохраняет текущий прогресс (статус отправки каждому получателю) в JSON-файл.
*   **Как работает:** Позволяет продолжить прерванную рассылку с того же места после перезапуска приложения, исключая дублирование сообщений.

#### `script_manager.py`
*   **Зачем:** Работа с шаблонами сообщений.
*   **Что делает:** Реализует функции создания, редактирования, удаления и загрузки шаблонов из папки `scripts/`.
*   **Как работает:** Хранит шаблоны в формате HTML. Приложение автоматически конвертирует их в Markdown V2 перед отправкой через Telegram.

#### `client_utils.py`
*   **Зачем:** Вспомогательные инструменты для работы с Telegram API.
*   **Что делает:** Содержит логику нормализации списков получателей.
*   **Как работает:** Преобразует ссылки типа `https://t.me/username` в формат `@username` или `chat_id`, понятный библиотеке Pyrogram.

#### `mini_broadcast.py`
*   **Зачем:** Модуль упрощенной "мини-рассылки".
*   **Что делает:** Реализует отдельное окно `MiniBroadcastApp` с фокусом на быстрый выбор чатов из папок и списка диалогов.
*   **Как работает:** Запускается из основного окна `main.py`. Использует общую базу сессий и механизмы блокировок (`broadcast.lock`) для предотвращения конфликтов с основной рассылкой.

---

### 3. Скрипты запуска и сборки

#### `run.command` (macOS)
*   **Зачем:** Упрощенный запуск приложения.
*   **Что делает:** Автоматически активирует виртуальное окружение и запускает `main.py`.

#### `setup.command` (macOS)
*   **Зачем:** Первоначальная установка.
*   **Что делает:** Разворачивает виртуальное окружение (`venv`) и устанавливает зависимости из `requirements.txt`.

#### `build_mac.sh`
*   **Зачем:** Сборка дистрибутива.
*   **Что делает:** Автоматизирует создание файлов `.app` и `.dmg` с помощью PyInstaller.

#### `tgflow.spec` и `tgflow_dist.spec`
*   **Зачем:** Конфигурация упаковщика PyInstaller.
*   **Что делает:** Описывает правила включения ресурсов (иконок, шаблонов) в итоговый исполняемый файл.

---

### 4. Конфигурация и Окружение

#### `requirements.txt`
*   **Зачем:** Управление зависимостями.
*   **Что делает:** Перечисляет все необходимые Python-библиотеки и их версии.

#### `.gitignore`
*   **Зачем:** Чистота репозитория.
*   **Что делает:** Исключает из Git временные файлы сборки, локальные конфиги и **конфиденциальные данные** (файлы сессий Telegram).

---

### 5. Документация

#### `README.md`
*   **Зачем:** Общее описание. Описывает возможности, установку и запуск приложения.

#### `CHANGELOG.md`
*   **Зачем:** История разработки. Фиксирует изменения в каждой версии.

#### `DEV_JOURNAL.md`
*   **Зачем:** Технический журнал. Содержит детали последних изменений (рефакторинг, переименование, удаление старой логики).

#### `docs/`
*   **`RFC-001-Architecture.md`**: Верхнеуровневое описание архитектуры.
*   **`RISKS-001-Init.md`**: Анализ технических рисков.
